<link rel="import" href="../../bower_components/polymer/polymer.html">
<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.12.4/mapbox-gl.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.12.4/mapbox-gl.css' rel='stylesheet' />
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
<dom-module id="taxi-visulization">
  <style is="custom-style" include="shared-styles">
    :host { margin:0; padding:0; }
    #map {margin: 0;height: 100vh;}
    #menu {
      background: #fff;
      position: absolute;
      z-index: 1;
      top: 20px;
      right: 10px;
      border-radius: 3px;
      width: 120px;
      border: 1px solid rgba(0,0,0,0.4);
      font-family: 'Open Sans', sans-serif;
    }

    #menu a {
      font-size: 13px;
      color: #404040;
      display: block;
      margin: 0;
      padding: 10px;
      text-decoration: none;
      border-bottom: 1px solid rgba(0,0,0,0.25);
      text-align: center;
    }

    #menu a:last-child {
      border: none;
    }

    #menu a:hover {
      background-color: #f8f8f8;
      color: #404040;
    }

    #menu a.active {
      background-color: #3887be;
      color: #ffffff;
    }

    #menu a.active:hover {
      background: #3074a4;
    }
    .intro{
      background: #434343;
      color: white;
      position: absolute;
      top: 180px;
      right: 10px;
      border-radius: 3px;
      width: 300px;
      border: 1px solid rgba(0,0,0,0.4);
      z-index: 2;
      height: 400px;
      padding: 20px;
    }
  </style>
  <template>
    <div id='map'></div>
    <nav id="menu"></nav>
    <div class="intro">
      <h4>New York City Taxi and Uber Trip Data Visualization</h4>
      <p>
        This map show every taxi pickup and drop off and uber pickup in New York
        City from the first five day of June 2014. More than 8 million data points is
        visualized on this map. The green points represent the taxi pickup, the red points
        represent the taxi dropoff, and the purple points represent the uber pickup. You can
        switch the visualization for each group (uber pickup, taxi pickup, taxi dropoff) by clicking
        the menu button. From this plot, we can also find out where it is easiest to catch a taxi.
      </p>
      <a target="_blank" href="https://nytpredictdraws.herokuapp.com/taxitrip"><button type="button" class="btn btn-default">Trip Predictor</button></a>
    </div>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'taxi-visulization',
        attached: function () {
          var _this = this;
          setTimeout(function () {
            _this.map.resize()
          }, 1000); //wait ten seconds before continuing
        },
        ready: function() {
          var _this = this;
          mapboxgl.accessToken = 'pk.eyJ1Ijoid3N0Y3B5dCIsImEiOiJjaWdibGRpN3YwcW9kYWdrbjF1Y2lpbzZjIn0.kjc-pPUimv9E8eBBvNTLnQ';
          var map = new mapboxgl.Map({
            container: _this.$$("#map"), // container id
            style: 'mapbox://styles/wstcpyt/cijry4bim006o8zkq2849dpcw', //stylesheet location
            center: [-73.9359, 40.75], // starting position
            zoom: 12 // starting zoom
          });
          this.map = map;
          map.on('style.load', function () {
            map.addSource('ubertrip', {
              type: 'vector',
              url: 'mapbox://wstcpyt.aq9j2rse'
            });
            map.addLayer({
              'id': 'ubertrip',
              'type': 'circle',
              'source': 'ubertrip',
              'paint': {
                'circle-radius': 2,
                'circle-color': 'rgba(116,7,219,1)'
              },
              'source-layer': 'uber_june_pickupgeojson'
            });
            map.addSource('taxipickup', {
              type: 'vector',
              url: 'mapbox://wstcpyt.1s1rp4bm'
            });
            map.addLayer({
              'id': 'taxipickup',
              'type': 'circle',
              'source': 'taxipickup',
              'paint': {
                'circle-radius': 2,
                'circle-color': 'rgba(55,145,28,1)'
              },
              'source-layer': 'taxipickupgeojson'
            });
            map.addSource('taxidropoff', {
              type: 'vector',
              url: 'mapbox://wstcpyt.d5sprtxd'
            });
            map.addLayer({
              'id': 'taxidropoff',
              'type': 'circle',
              'source': 'taxidropoff',
              'paint': {
                'circle-radius': 2,
                'circle-color': 'rgba(242,31,31,1)'
              },
              'source-layer': 'taxidropoffgeojson'
            });
          });
          addLayer('UberPickup', 'ubertrip');
          addLayer('TaxiPickup', 'taxipickup');
          addLayer('TaxiDropoff', 'taxidropoff');

          function addLayer(name, id) {
            var link = document.createElement('a');
            link.href = '#';
            link.className = 'active';
            link.textContent = name;

            link.onclick = function (e) {
              e.preventDefault();
              e.stopPropagation();

              var visibility = map.getLayoutProperty(id, 'visibility');

              if (visibility === 'visible') {
                map.setLayoutProperty(id, 'visibility', 'none');
                this.className = '';
              } else {
                this.className = 'active';
                map.setLayoutProperty(id, 'visibility', 'visible');
              }
            };

            var layers = _this.$$('#menu');
            Polymer.dom(layers).appendChild(link)
          }
        }
      });
    })();
  </script>
</dom-module>
